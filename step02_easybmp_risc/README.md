## Шаг 2. Портирование. Запуск программы на NMC 

*В данном уроке создадим  проект и запустим приложение на NMC*  


На предыдущем шаге мы подготовили исходные тексты для переноcа на NMC.  
Рассмотрим два варианта портирования проекта под NMC:  
- standalone-приложение. Создается исполняемый файл только для NMC. В зависимости от целевой платы NMC-приложение запускается с помощью специальной программы-загрузчика (mb7707run/mc5103run/mc7601run/nm6405emurun...) . 
- Приложение с управляющей хостовой частью программы на PC и вычислительной на NMC.

### Создание standalone-NMC-приложения

#### Схема работа приложения
- В **main.cpp** создаются входной и выходной буфера, где с помощью прагм массивы привязываются к секциям для внешнего обмена данными:   
```cpp
#pragma data_section ".data_shared_src.bss"
	long long src_pgm_file[1920*1080/8+64/8];
#pragma data_section ".data_shared_dst.bss"
	long long dst_pgm_file[1920*1080/8+64/8];
```
- В конфигурационном файле задается расположение этих секций в разделяемой памяти, доступной для загрузчика. 
- Приложение запускается загрузчиком (например mb7707run). 
- До момента передачи управления в функцию *main()* загрузчик пишет исходное изображение **Lena224x240.pgm** в секцию **.data_shared_src.bss** , соответствующую входному массиву **src_pgm_file** (адрес загрузки задается ключом --send_sect) 
- Далее программа стартует и читает входной заголовок изображение в формате PGM (read_pgm_header)  
- Создается результирующий заголовок изображение в формате PGM (save_pgm_header)
- Определяются адреса **src** и **dst** непосредственно данных изображений после PGM-заголовков.  
- Вызывается функция **sobel**
- По окончанию работы функции **main** загрузчик читает область памяти из секции **.data_shared_dst.bss**  и сохраняет ее в результирующий файл *Sobel.pgm*


#### Настройка  и сборка проекта 
Сборка и запуск проекта осуществляется через Makefile.  
В Makefile  указываем необходимые пути к заголовочным файлам и библиотекам:  
```mk
INC_DIRS         = -I"$(NEURO)/include" -I"$(MB7707)/include" -I"$(NMPP)/include" -I. -I../.. -I$(ROOT)/deps/EasyPGM
LIB_DIRS         = -L"$(NEURO)/lib" -L"$(MB7707)/lib" -L"$(NMPP)/lib"
```
Указываем библиотеки
```mk
LIBS             = libint_soc.lib mb7707lib.lib libc05.lib cppnew05.lib nmpp_NMC3.lib
```
Исходные тексты задаются в виде относительных путей к ним. Все имеющиеся .c и .cpp файлы в этих каталогах будут автоматически подключены в проект
```mk
SRC_DIRS         = .. ../.. $(ROOT)/deps/EasyPGM
```

Указываем опции линкера и размеры куч:
```mk
BUILDER_FLAGS    = -cmb7707brd.cfg -m  -heap=554432 -heap1=0 -heap2=0 -heap3=0 -full_names -o$(TARGET) $(LIB_DIRS)
```

Запуск приложения осуществляется командой *make run* согласно правилу:
```mk
run: $(TARGET)
	$(MB7707)/bin/mb7707run -i -a$(MB7707_MAC) $(TARGET) --send_file_name=$(ROOT)/input/Lena224x240.pgm --send_sect=.data_shared_src.bss --recv_file_name=Sobel.pgm --recv_sect=.data_shared_dst.bss  --recv_size=0x348a
```
> **MB7707_MAC** - необходимо установить соответственно адресу вашей сетевой карты. 
> В дальнейшим в примерах c хост частью будет использоваться адрес 1a-2b-3c-4d-5e-6f, для удобства рекомендуется выставить такой же MAC адрес для сетвой карты.


В конфигурационном файле (mb7707brd.cfg) располагаем секции обмена в разделяемой памяти :
```cfg
MEMORY
{
    EXTERNAL_MEM_BANK0:  at  0x10000000, len = 0x02000000; // 128MB-EM0-DDR (ARM:0x40000000    0x7fffffff) 
}

SEGMENTS
{
    ext_data0    : in EXTERNAL_MEM_BANK0;
}

SECTIONS
{
    //--------- exchange sections -----------------
    .data_shared_src.bss          : in ext_data0;
    .data_shared_dst.bss          : in ext_data0;
}
```

Сборка программы осуществляется командой *make*, запуск - *make run*.   
В результате работы программы должно сформироваться изображение **sobel.pgm**  
![Рис.1](http://savepic.ru/7691336.png)



### Создание приложения с хостовой частью. 

Проект состоит из двух частей - хостовой /mb7707/pc и целевой /mb7707/nm.  
Хостовая часть необходима для:  
- загрузки исполняемого NMC-кода на МС77.07 
- чтения  файла src.bmp  
- загрузки ч/б изображения на плату  
- считывание результата обработки с платы  
- сохранения результата в dst.bmp  

Целевая часть ждет получения изображения от хоста и обрабатывает его фильтром Собеля 

Общие файлы (sobel.cpp sobel.h ), которые также используются в сборках для других целевых платформ, лежат в корне папки */step02_easybmp_risc*

#### Создаем целевое NMC-приложение
Работа целевого приложения отличается от standalone приложения, только тем, что файл изображения разбирается на стороне хоста и передается на NMC-часть в виде массива пикслей.
Для барьерной синхронизации используются функции библиотеки загрузки и обмена: **ncl_sync** - на стороне NMC и ответная функция **PL_Sync** - на стороне PC.
Для компактности кода функции загрузки и обмена для PC обенруты в соответствующие методы класса **C_PC_Connector_mb7707** 

#### Создаем host-приложение
Аналогично прописываем пути в Makefile для хост приложения
```
INC_DIRS         = -I"$(MB7707)/pc/include" -I$(ROOT)/deps/connector -I$(ROOT)/deps/EasyBMP
LIB_DIRS         = -L"$(MB7707)/pc/lib"
SRC_DIRS         = .. $(ROOT)/deps/EasyBMP
LIBS             = mb7707load.lib
```
Работу с bmp файлами осуществляем через библиотеку EasyBMP
Доступ к плате для удобства осуществляется через класс **C_PC_Connector_mb7707** , на вход конструктора которого необходимо передать имя исполняемого плата и MAC адрес сетевого контролера к которому подсоединена плата.


В результате исполнения в этой же папке должен появиться dst.bmp

#### Производительность: 
- 1203625826 clocks per frame 
- 14247 clocks per pixel
- 0.265863 fps




 



