# sobel-steps

Руководство предназначено для ознакомления с программированием процессоров сеймейства NeuroMatrix, работой с инструментальными платами МВ77.07 и МС5103.
Описывается процесс последовательной модификации DSP-приложения в виде серии шагов начиная от запуска простой поведенческой С++ модели 
до разработки высоко-оптимизированного кода под векторный сопроцессор.
В качестве примера используются широко применяемый в области ЦОС фильтр Собеля.


*Step by step DSP application development for NeuroMatrix . There are examples of filter Sobel  starting from simple C++ model to high-optimized application using NeuroMatrix vector co-processor*

Предлагаемая серия шагов является избыточной с точки зрения реального построения программ, однако позволяет лучше понять нюансы программирования под NeuroMatrix ,
представить возможности архитектуры, а также имеющихся средств разработки.  
В процессе изучения будут рассмотрены следующие вопросы:
- Изучение способов портирования готовых приложений с x86 плафтормы на NMC
- Обеспечение кроссплафторменности исходных текстов. 
- Запуск приложений в автономном режиме для плат МЦ5103 и MB7707 
- Запуск приложения под управлением хост-программы для плат МЦ5103 и MB7707
- Работа с графической оболочки VSHELL для упрощения разработки и отладки ЦОС-приложений 
- Запуск программного кода на RISC-ядре
- Подключение векторной библиотеки NMPP и перенос кода на векторный сопроцессор
- Оптимизация алгоритма, ускорение кода - разработка спец. функций на ассемблере 
- Модификации алгоритма - перенос обработки из внешней памяти - в быструю внутреннюю
- Профилирование
- Распараллеливание потоков данных по внутренним банкам памяти.  
- Работа с видеопамятью MB7707 , вывод изображения на телевизор через HDMI


## Установка утилит и средств разработки под Windows 
Данный проект <sobel-steps> имеет несколько зависимостей от библиотек и системного ПО:
- nmsdk (SDK для сборки программ под NMC)
- mc5103sdk (по поддержки для платы МЦ5103)
- mc7601sdk (по поддержки для платы МЦ7601)
- mb7707sdk (по поддержки для платы МВ77.07)
- nmpp (Библиотека поддержки базовых векторно-матричных функций на процессорах семейства NeuroMatrix)
- nmprofiler (библиотека профилирования)
- vshell32 (графическая оболочка для разработки видеоприложений под Windows)

Хотя некоторые пакеты могут изначально присутствовать, для обеспечения совместимости версий и
упрощения процедуры установки все зависимые компоненты подгружаются через интернет с сайта разработчика в локальную папку
<install_sobel_path>/sobel-steps/deps и дальше вызываются оттуда. При этом никаких изменений переменных окружения не требуется и не производится.
 
Скачать и установить все необходимые компоненты можно командой командой
```bat
make install
```

> Для скачивания через прокси необходимо создать файл /sobel-steps/proxy.mk и определить переменную 
```mak 
 http_proxy = http://user:pass@proxy:80/ 
```



Для корректного исполнения сборочных Makefile скриптов под Windows необходимо, чтобы были установлены следующие утилиты:
- **Make for Windows**. [Скачать инсталлятор](http://gnuwin32.sourceforge.net/downlinks/make.php). Домашняя страница: http://gnuwin32.sourceforge.net/packages/make.htm
- **Wget for Windows**. [Скачать инсталлятор](http://downloads.sourceforge.net/gnuwin32/wget-1.11.4-1-setup.exe). Домашняя страница http://gnuwin32.sourceforge.net/packages/wget.htm
- **UnZip for Windows** [Скачать инсталлятор](http://gnuwin32.sourceforge.net/downlinks/unzip.php). Домашняя страница http://gnuwin32.sourceforge.net/packages/unzip.htm  
> Утилиты должны быть доступны через переменную окружения PATH.  
> Пути к **wget** и **unzip** можно не прописывать в PATH если при их установке указать папку <install_sobel_path>/sobel-steps/gnuwin32


В приведенных шагах могут присутствовать несколько вариантов работы с отладочными модулями: 
- полностью автономное (standalone) приложение , запускаемое средствами ПО поддержки плат.
- двух-компонетные приложения (host-taget), где загрузка и управление NMC-программой на плате
 осуществляется со стороны хост-программы, разработанной на С++ в среде Microsoft Visual Studio (2005 или 2013)

Соответственно для второго варианта также требуется установленная версия Miсrosoft Visual Studio 
 * [Visual Studio 2005 Express](http://apdubey.blogspot.ru/2009/04/microsoft-visual-studio-2005-express.html)
 * [Visual Studio 2013 Express](https://www.microsoft.com/en-US/download/details.aspx?id=44914)  

> Драйвера плат (MC5103,МВ77.07,МС7601..)   предполагается уже установлены пользователем 
 
### Загрузка  видеороликов 
 
В качестве тестовых данных используются изображения в формате bmp, pgm и видеоролики .
Тестовые видео-ролики подгружаются отдельно в папку  <install_sobel_path>/sobel-steps/input командой 
```bat
make avi
```
  

### Сборка и запуск
1. В файле  <install_sobel_path>/sobel-steps/env.mk  в соответствующих переменных указать пути к установленным библиотекам и ПО
2. Запуск host-target приложения (с автоматической сборкой nm и pc части) осуществляется командой
```mak
 make run
```
  из соответствующий папки хостовой части приложения, например 'mb7707/pc/make_vs08'
3. Запуск автономного(standalone) приложения  осуществляется также командой 
```mak
make run
```
из соответствующий папки /standalone/
3. При работе с платой MB77.07 в pc/main.cpp необходимо переопределить MAC-адрес сетевого адаптера подключенного к плате . А при работе с платой этот MAC-адрес требуется задать в environment.mk .
 По умолчанию используется 
```cpp
  unsigned char MAC_ADDRESS[] = {0x1a, 0x2b, 0x3c, 0x4d, 0x5e, 0x6f};
```	
4. Убедиться, что перемычка на плате MB77.07 установлена (Загрузка OS Linux - не производится). 



### Содержание 
#### Шаг 0. [Реализация прототипа фильтра Собеля для хоста ](/step00_easybmp_prototype/)
 Рассматривается поведенческая модель. Запуск на хосте.
#### Шаг 1. [Подготовка к портированию на NMC](/step01_easybmp_port2nmc/)
 Адаптация кода для обеспечения кроссплатформенности 
#### Шаг 2. [Портирование. Запуск программы на NMC](/step02_easybmp_risc/)
 Осуществляется запуск модели на хосте, на RISC ядре процессора NMC на платах MB77.07 и МС5103
#### Шаг 3. [Портирование алгоритма на векторный процессор](/step03_easybmp_nmpp/)
  Используем векторные функции из состава NMPP 
#### Шаг 4. [Подключение графической оболочки VSHELL ](/step04_vshell_nmpp/)
 Переход от единичной обработки к покадровой используя графическую оболочку VSHELL
#### Шаг 5. [Оптимизация градиентных фильтров  ](/step05_filter_optimization/)
 Переход от двумерной фильтрации к одномерной 
#### Шаг 6. [Оптимизация динамического выделения памяти ](/step06_class/)
 Использование классов.
#### Шаг 7. [Модификация программы для работы во внутренней памяти nmc](/step07_internal_memory/)
 Переход к кусочной обработке изображения во внутренней памяти.
#### Шаг 8. [Устранение граничных дефектов кусочной обработки](/step08_edge_removal/)
#### Шаг 9. [Профилирование](/step09_profiling/)
#### Шаг 10. [Оптимизация векторных функций ](/step10_nmpp_optimization/)
#### Шаг 11. [Оптимизация фильтра выделения горизонтальных границ ](/step11_filter3h/)
#### Шаг 12. [Оптимизация фильтра выделения вертикальных границ ](/step12_filter3v/)
#### Шаг 13. [Распараллеливание входных и выходных потоков данных ](/step13_memory_optimization/)
#### Шаг 14. [Определение пиковой производительности](/step14_max_performance/)
#### Шаг 15. [HDMI вывод на экран в SD разрешении](/step15_hdmi_sd/)
#### Шаг 16. [HDMI вывод на экран в HD разрешении](/step16_hdmi_hd/)


 